---
import { getCollection } from 'astro:content'
import rss from '@astrojs/rss'
import { siteConfig } from '../config.js'

const blog = await getCollection('blog')
const posts = blog
  .filter((post) => !post.data.draft)
  .sort((a, b) => {
    const dateA = new Date(b.data.publishDate)
    const dateB = new Date(a.data.publishDate)
    return dateA.getTime() - dateB.getTime()
  })

export async function GET(context) {
  return rss({
    title: `${siteConfig.name}'s Blog`,
    description: siteConfig.bio,
    site: context.site,
    items: posts.map((post) => ({
      title: post.data.title,
      pubDate: new Date(post.data.publishDate),
      description: post.data.description,
      link: `/blog/${post.slug}`,
      author: siteConfig.email,
      categories: post.data.tags,
    })),
    customData: `<language>en-us</language>`,
  })
}
---
